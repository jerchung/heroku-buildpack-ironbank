#!/bin/bash

BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

##
## Constants
## 

MAVEN_URL="http://www.gtlib.gatech.edu/pub/apache/maven/maven-3/3.3.9/binaries/apache-maven-3.3.9-bin.tar.gz"
MAVEN_DIR="apache-maven-3.3.9"
JETTY_URL="http://repo2.maven.org/maven2/org/mortbay/jetty/jetty-runner/8.1.9.v20130131/jetty-runner-8.1.9.v20130131.jar"

##
## Helper functions
##
status() {
    echo "-----> $1"
}

export_env_dir() {
  env_dir=$3
  whitelist_regex=${2:-''}
  blacklist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  if [ -d "$env_dir" ]; then
    for e in $(ls $env_dir); do
      echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
      export "$e=$(cat $env_dir/$e)"
      :
    done
  fi
}

##
## Code
##

# Pull in all env vars
export_env_dir

# Set up Maven
if [ ! -d "$CACHE_DIR/$MAVEN_DIR" ]; then
    status "Cached Maven binary not found, downloading"
    wget -qO- "$MAVEN_URL" | tar xz
    cp -r "$MAVEN_DIR" "$CACHE_DIR"
else
    status "Found cached Maven binary"
    cp -r "$CACHE_DIR/$MAVEN_DIR" .
fi
export PATH="$PATH:$(pwd)/$MAVEN_DIR/bin"

# Copy over Maven settings
mkdir -p ~/.m2
cp "$BUILD_DIR/assets/settings.xml" ~/.m2

# Set up cached Maven repository
if [ -d "$CACHE_DIR/.m2" ]; then
    status "Found cached ~/.m2/repository"
    cp -r "$CACHE_DIR/.m2" ~/
fi

# Build entire project
cd "$BUILD_DIR"
mvn install -DskipTests=true

# Cache Maven repository
rm -rf "$CACHE_DIR/.m2"
cp -r ~/.m2 "$CACHE_DIR"

# Initialize Play! and precompile it. Required before building WAR
mvn play:initialize play:precompile --projects ironbank-credit

# Build WAR goal. We need to remove the Play! dependency from the POM due to a
# "duplicate file" issue when building the WAR
tr -d '\r\n' < ironbank-credit/pom.xml | perl -pe 's#<dependency>[ \t]+<groupId>com\.lendup\.playframework.*?</dependency>##g' > ironbank-credit/new-pom.xml
mv ironbank-credit/new-pom.xml ironbank-credit/pom.xml
mvn play:war-exploded

cat ironbank-credit/target/war/WEB-INF/web.xml

# Make the JS directory in the WAR directory and copy static files to it
mkdir -p ironbank-credit/target/war/WEB-INF/application/src/main/javascript
cp -r ironbank-credit/src/main/javascript/static ironbank-credit/target/war/WEB-INF/application/src/main/javascript

# Build the actual WAR archive
jar cvf app.war ironbank-credit/target/war

# Download jetty-runner
wget "$JETTY_URL"
